version: v1
kind: kubernetes
application: pxbbq

targets:
  eks03-prod:
    account: eks03-prod
    namespace: pxbbq
    strategy: myCanary
  #  constraints:
  #    dependsOn:
  #    - staging
  "Migrate Prod DB To Staging":
    account: eks03-prod
    namespace: pxbbq
    strategy: myCanary
    constraints:
      afterDeployment:
        runWebhook:
          name: Wait for DB Migration
  #staging:
  #  account: eks01-staging
  #  namespace: pxbbq
  #  strategy: myCanary
  #  constraints:
  #    dependsOn:
  #    - "Migrate Prod DB To Staging"

manifests:
  - path: pxbbq-demo/mongodb.yaml
  - path: pxbbq-demo/pxbbq.yaml
  - path: pxbbq-demo/migrate.yaml
    targets: ['Migrate Prod DB To Staging']
  
strategies:
  myCanary:
    canary:
      steps:
        - setWeight:
            weight: 50
        - pause:
            untilApproved: true
        - setWeight:
            weight: 100
            
webhooks: 
  - agentIdentifier: {{armory.accountName}} #eks03-prod
    bodyTemplate:
      inline: '{ "cmd": "kubectl", "arg": "wait -n={{armory.namespace}} migration/migrate01 --for=condition=Completed --timeout=30m", "callbackURL": "{{armory.callbackUri}}/callback" }'
    method: POST
    name: Wait for DB Migration
    networkMode: remoteNetworkAgent
    retryCount: 3
    uriTemplate: http://cmd-hook.armory-rna:8081/cmd

